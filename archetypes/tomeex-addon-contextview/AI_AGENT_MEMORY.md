# AI Agent Memory: ContextView Maven Archetype

## Purpose of This Document
This document serves as a comprehensive knowledge base for AI agents working on the ContextView Maven Archetype project. It contains complete architectural context, technical patterns, and historical decisions needed to understand and continue development.

---

## System Architecture Overview

### What is the ContextView System?

**Core Philosophy: JSON-Driven Architecture**

The system implements a declarative, configuration-driven approach to web application development where:
- **UI structure** is defined in JSON, not hardcoded in HTML/JSP
- **Data grids** are configured via JSON schemas, not manually coded
- **Forms** are generated from JSON field definitions
- **Navigation** and workflows are contextview-based configurations
- **Business logic** uses pattern-based controllers (DataTableHelper pattern)

### The Two Implementations

**2. Java Maven Archetype (This Project)**
- Single-module Jakarta EE integration package
- Generated as add-on for existing Java webapps
- Configuration: `WEB-INF/contextviews/json/main.json`
- Parsing logic: `ScenarioProcessor.java` (translated from PHP)
- API pattern: `/api/contextview/{action}`

---

## Critical Architecture Decisions

### Decision 1: Single Module Model

**Initial Mistake**: First archetype version assumed multi-module architecture like PHP.

**Correction**: A Java webapp generated by this archetype = ONE module only.

**Implications**:
- Configuration file always named `main.json` (not `{moduleName}.json`)
- No module selection in API endpoints
- Simpler path structure: `contextviews/json/main.json`
- API becomes: `/api/contextview/config` (not `/api/contextview/config/{module}`)

**Why This Matters**:
```

Java (Single Module):
  WEB-INF/contextviews/json/main.json
  API: /api/contextview/LIST_RAPPORTO, /api/contextview/LIST_FAQ
```

### Decision 2: Add-On Integration Model

**Initial Mistake**: First version generated complete standalone webapp.

**Correction**: Archetype generates integration package to copy into existing webapp.

**New Parameters**:
- `targetWebapp` - Name of existing webapp (e.g., "my-app")
- `targetWebappPath` - Path to existing webapp directory

**Usage Model**:
```bash
# Generate integration package
mvn archetype:generate \
  -DarchetypeGroupId=com.sportello \
  -DarchetypeArtifactId=sportello-contextview-archetype \
  -DgroupId=com.example \
  -DartifactId=contextview-integration \
  -Dpackage=com.example.contextview \
  -DtargetWebapp=my-existing-app

# Copy generated files into existing webapp
cd contextview-integration
# Copy src/main/java/* to existing webapp
# Copy src/main/webapp/* to existing webapp
# Merge web.xml configuration
```

### Decision 3: Fixed Configuration Filename

**Initial Design**: Configuration named `{artifactId}.json` or `{targetWebapp}.json`

**Final Design**: Always `main.json`

**Rationale**: Predictability and simplicity. No variation needed since webapp = single module.

**Code Impact**:
```java
// ScenarioServlet.java - Line 63
appName = "main"; // Always "main" for main.json

// ScenarioServlet.java - Line 143
String jsonPath = "json/main.json"; // Fixed filename
```

---

## Core Concepts to Learn

### 1. ContextView-Based Navigation

**What is a ContextView?**
A contextview represents a page/screen in the application with specific behavior.

**ContextView Types**:
- `LIST` - Data grid (table with rows)
- `FORM` - Edit form (create/update)
- `DETAIL` - Read-only view
- `HOME` - Landing page
- `MENU` - Navigation item only

**Example ContextView** (`main.json`):
```json
{
  "contextviews": {
    "LIST_PRODUCTS": {
      "title": "Product List",
      "route": "products",
      "component": "custom-grid",
      "roles": ["admin", "user"],
      "menu": {
        "home": {
          "order": "1",
          "title": "Products",
          "icon": "it-list"
        }
      },
      "options": {
        "schema": "PRODUCT_LIST",
        "api": [
          {"method": "GET", "url": "api/products"}
        ],
        "actions-row": {
          "items": [
            {
              "code": "detail",
              "title": "View",
              "goto-contextview": "PRODUCT_DETAIL"
            }
          ]
        }
      }
    }
  }
}
```

**Key Fields**:
- `title` - Display title
- `route` - URL path segment
- `component` - Frontend component type (custom-grid, custom-form, custom-view)
- `roles` - Array of authorized roles
- `menu` - Menu entry configuration
- `options.schema` - Reference to schema file (triggers schema inlining)
- `options.api` - REST API endpoints for data operations
- `actions-row` - Row-level actions (edit, delete, view)
- `goto-contextview` - Navigation target (creates breadcrumb relationship)

### 2. Schema Inlining Pattern

**Problem**: Separate schema files need to be merged into contextview configuration.

**Solution**: Automatic schema loading and inlining.

**How It Works**:

**Step 1**: ContextView references schema
```json
// main.json
{
  "contextviews": {
    "LIST_PRODUCTS": {
      "options": {
        "schema": "PRODUCT_LIST"
      }
    }
  }
}
```

**Step 2**: Processor loads schema file
```
Path: json/forms/PRODUCT_LIST.json
```

**Step 3**: Schema content merged into contextview
```json
// Processed output sent to frontend
{
  "contextviews": {
    "LIST_PRODUCTS": {
      "options": {
        "schema": "PRODUCT_LIST",
        "schema_content": {
          "schema": {
            "id": {"type": "number", "title": "ID"},
            "name": {"type": "string", "title": "Name"}
          },
          "grid": [
            {"key": "id"},
            {"key": "name"}
          ]
        }
      }
    }
  }
}
```

**Code Implementation** (ScenarioProcessor.java:146-189):
```java
private void processScenarios(ObjectNode mainConfig, JsonNode contextviews, String basePath) {
    Iterator<Map.Entry<String, JsonNode>> fields = contextviews.fields();
    while (fields.hasNext()) {
        Map.Entry<String, JsonNode> entry = fields.next();
        ObjectNode contextview = (ObjectNode) entry.getValue();

        if (contextview.has("options")) {
            ObjectNode options = (ObjectNode) contextview.get("options");

            // Check for schema reference
            if (options.has("schema")) {
                String schemaName = options.get("schema").asText();

                // Build schema path: forms/{schemaName}.json
                Path schemaPath = scenariosBasePath
                    .resolve("json/forms")
                    .resolve(schemaName + ".json");

                // Load and inline schema
                if (Files.exists(schemaPath)) {
                    JsonNode schemaContent = loadJsonFile(schemaPath.toString());
                    options.set("schema_content", schemaContent);
                }
            }
        }
    }
}
```

### 3. Role-Based Authorization

**Authorization Wildcards**:
- `*` - Any authenticated user
- `!` - Non-authenticated (guest) only
- `@` - Authenticated but not validated
- `role_name` - Specific role (e.g., "admin", "user")

**Example**:
```json
{
  "contextviews": {
    "HOME": {
      "roles": ["*"]  // Anyone logged in
    },
    "ADMIN_PANEL": {
      "roles": ["admin"]  // Only admin role
    },
    "LOGIN": {
      "roles": ["!"]  // Only guests (not logged in)
    }
  }
}
```

**Processing Logic** (RoleAuthorizationFilter.java):
```java
private boolean isRoleAuthorized(ObjectNode node, String userRole) {
    if (!node.has("role") && !node.has("roles")) {
        return true; // No restriction
    }

    List<String> allowedRoles = extractRoles(node);

    // Check wildcards
    if (allowedRoles.contains("*")) {
        return userRole != null; // Any authenticated
    }
    if (allowedRoles.contains("!")) {
        return userRole == null; // Only guests
    }
    if (allowedRoles.contains("@")) {
        return userRole != null && !validationTerms; // Unvalidated
    }

    // Check specific role
    return allowedRoles.contains(userRole);
}
```

**Filtering Impact**:
- Unauthorized contextviews removed from `contextviews` object
- Unauthorized menu items removed from `menu` object
- Unauthorized actions removed from `actions-row`, `actions-bottom`

### 4. Breadcrumb Generation

**Purpose**: Automatic hierarchical navigation based on contextview relationships.

**How Relationships Are Detected**:
- `goto-contextview` field in actions creates parent-child relationship
- Recursive algorithm walks up the chain
- Maximum depth: 10 levels

**Example**:
```json
// main.json
{
  "contextviews": {
    "HOME": {
      "title": "Home",
      "route": "/home"
    },
    "LIST_PRODUCTS": {
      "title": "Products",
      "route": "products",
      "options": {
        "actions-row": {
          "items": [
            {"goto-contextview": "PRODUCT_DETAIL"}
          ]
        }
      }
    },
    "PRODUCT_DETAIL": {
      "title": "Product Details",
      "route": "products/detail"
    }
  }
}
```

**Generated Breadcrumbs for PRODUCT_DETAIL**:
```json
{
  "breadcrumb": [
    {"title": "Home", "route": "/home", "contextview": "HOME"},
    {"title": "Products", "route": "products", "contextview": "LIST_PRODUCTS"},
    {"title": "Product Details", "route": "products/detail", "contextview": "PRODUCT_DETAIL"}
  ]
}
```

**Algorithm** (BreadcrumbGenerator.java:74-148):
```java
private List<BreadcrumbEntry> generateBreadcrumb(
    String scenarioKey, ObjectNode allScenarios, int depth
) {
    if (depth > 10) return new ArrayList<>();

    ObjectNode currentScenario = (ObjectNode) allScenarios.get(scenarioKey);
    List<BreadcrumbEntry> breadcrumb = new ArrayList<>();

    // Find parent contextview (who has goto-contextview pointing here)
    String parentKey = findParentScenario(scenarioKey, allScenarios);

    if (parentKey != null) {
        // Recursive: get parent's breadcrumb first
        breadcrumb.addAll(generateBreadcrumb(parentKey, allScenarios, depth + 1));
    }

    // Add current contextview to breadcrumb
    breadcrumb.add(new BreadcrumbEntry(
        currentScenario.get("title").asText(),
        currentScenario.get("route").asText(),
        scenarioKey
    ));

    return breadcrumb;
}
```

---

### Schema Processing

**PHP**: Inline loop in `readConfiguration()` (lines 360-384)
**Java**: `ScenarioProcessor.processScenarios()` (lines 146-189)

| PHP Logic | Java Implementation |
|-----------|---------------------|
| `foreach($jsonData['contextviews'] as $key => $contextview)` | `Iterator<Map.Entry<String, JsonNode>> fields = contextviews.fields();` |
| `if(isset($contextview['options']['schema']))` | `if (options.has("schema"))` |
| `$schemaName = $contextview['options']['schema'];` | `String schemaName = options.get("schema").asText();` |
| `$schemaPath = "forms/" . $schemaName . ".json";` | `Path schemaPath = basePath.resolve("json/forms").resolve(schemaName + ".json");` |
| `$schema = json_decode(file_get_contents($fullPath), true);` | `JsonNode schemaContent = loadJsonFile(schemaPath.toString());` |
| `$contextview['options']['schema_content'] = $schema;` | `options.set("schema_content", schemaContent);` |

### Role Authorization Filter

**Java**: `RoleAuthorizationFilter.filterByRole()` (lines 32-81)

### Breadcrumb Generation

**Java**: `BreadcrumbGenerator.addBreadcrumbs()` (lines 35-70)

| PHP Pattern | Java Pattern |
|-------------|--------------|
| `private static function recBreadcrumb($scenario_name, $contextviews, $depth = 0)` | `private List<BreadcrumbEntry> generateBreadcrumb(String scenarioKey, ObjectNode allScenarios, int depth)` |
| `if($depth > 10) return [];` | `if (depth > 10) return new ArrayList<>();` |
| `foreach($contextviews as $key => $value)` loop to find parent | `findParentScenario(scenarioKey, allScenarios)` method |
| Check `goto-contextview` in actions | Search in `actions-row`, `actions-bottom`, `actions-top` |
| `array_merge($result, [$current_breadcrumb])` | `breadcrumb.addAll(parentBreadcrumb); breadcrumb.add(current);` |
| Return PHP array | Return `List<BreadcrumbEntry>` |

---

## Critical Files and Their Purpose

### 1. archetype-metadata.xml
**Path**: `maven-archetype/src/main/resources/META-INF/maven/archetype-metadata.xml`

**Purpose**: Maven archetype descriptor defining generation parameters and file processing.

**Critical Parameters**:
```xml
<requiredProperty key="targetWebapp">
    <defaultValue>my-webapp</defaultValue>
</requiredProperty>
<requiredProperty key="targetWebappPath">
    <defaultValue>/path/to/existing-webapp</defaultValue>
</requiredProperty>
```

**Feature Flags**:
- `enableCustomGrid` - Grid component support
- `enableCustomForm` - Form component support
- `enableRoleAuthorization` - Role filtering
- `enableBreadcrumbs` - Breadcrumb generation
- `enableSchemaValidation` - JSON schema validation

**Why It Matters**: This file controls what gets generated. Feature flags use Velocity conditionals in templates.

### 2. ScenarioProcessor.java
**Path**: `archetype-resources/src/main/java/contextview/processor/ScenarioProcessor.java`

**Purpose**: Core translation of PHP parsing logic. Main orchestrator.

**Key Methods**:
- `processConfiguration()` - Main entry point (lines 91-128)
- `processScenarios()` - Schema inlining (lines 146-189)
- `loadJsonFile()` - JSON loading with error handling (lines 199-211)

**Dependencies**:
- Jackson ObjectMapper for JSON
- RoleAuthorizationFilter (optional, feature flag)
- BreadcrumbGenerator (optional, feature flag)

**Usage in Servlet**:
```java
ScenarioProcessor processor = new ScenarioProcessor(Paths.get(scenariosPath));
JsonNode config = processor.processConfiguration("json/main.json", role, true, false);
```

### 3. ScenarioServlet.java
**Path**: `archetype-resources/src/main/java/contextview/servlet/ScenarioServlet.java`

**Purpose**: REST API endpoints for frontend consumption.

**API Endpoints**:
- `GET /api/contextview/config` - Full processed configuration
- `GET /api/contextview/list` - List all contextviews
- `GET /api/contextview/{scenarioKey}` - Specific contextview

**Critical Lines**:
- Line 60: `appName = getServletContext().getInitParameter("app.name");`
- Line 63: `if (appName == null) { appName = "main"; }` - Default to "main"
- Line 143: `String jsonPath = String.format("json/%s.json", appName);` - Always "json/main.json"

**Request Flow**:
```
HTTP GET /api/contextview/config?role=admin
  ↓
ScenarioServlet.doGet()
  ↓
handleGetConfiguration()
  ↓
processor.processConfiguration("json/main.json", "admin", true, false)
  ↓
Return processed JSON
```

### 4. main.json
**Path**: `archetype-resources/src/main/webapp/WEB-INF/contextviews/json/main.json`

**Purpose**: Master configuration file for entire webapp.

**Structure**:
```json
{
  "name": "${targetWebapp}",
  "description": "ContextView Configuration",

  "translate_instance_status": {
    "1": {"title": "Draft"},
    "2": {"title": "In Progress"}
  },

  "translate_icons": {
    "home": {"icon": "it-home"},
    "list": {"icon": "it-list"}
  },

  "options": {
    "serviceTermsRequired": false
  },

  "contextviews": {
    "HOME": { /* ... */ },
    "LIST_EXAMPLE": { /* ... */ },
    "EXAMPLE_DETAIL": { /* ... */ }
  }
}
```

**Why Always "main.json"**: Predictability and simplicity for single-module architecture.

### 5. web.xml
**Path**: `archetype-resources/src/main/webapp/WEB-INF/web.xml`

**Purpose**: Jakarta EE deployment descriptor with contextview system configuration.

**Critical Configuration**:
```xml
<context-param>
    <param-name>app.name</param-name>
    <param-value>main</param-value>
    <description>Config filename (always "main" for main.json)</description>
</context-param>

<context-param>
    <param-name>contextviews.path</param-name>
    <param-value>${symbol_dollar}{catalina.base}/webapps/${targetWebapp}/WEB-INF/contextviews</param-value>
    <description>Path to contextviews directory</description>
</context-param>
```

**Velocity Variables**:
- `${symbol_dollar}` - Escaped `$` for Velocity (becomes `$` in output)
- `${targetWebapp}` - User-provided webapp name

**Integration Instructions**: This file should be merged into existing webapp's web.xml, not replaced.

---

## Complete File Structure

```
maven-archetype/
├── pom.xml                                    # Archetype build configuration
│   └── <packaging>maven-archetype</packaging>
│
├── src/main/resources/
│   ├── META-INF/maven/
│   │   └── archetype-metadata.xml            # Generation parameters & feature flags
│   │
│   └── archetype-resources/
│       ├── pom.xml                            # Generated project POM (Velocity template)
│       │
│       ├── src/main/java/contextview/
│       │   ├── core/
│       │   │   ├── ContextView.java             # Data model for contextview
│       │   │   └── ScenarioOptions.java      # Data model for contextview options
│       │   │
│       │   ├── processor/
│       │   │   ├── ScenarioProcessor.java    # Core: PHP readConfiguration() translation
│       │   │   ├── RoleAuthorizationFilter.java  # Role filtering logic
│       │   │   ├── BreadcrumbGenerator.java  # Breadcrumb generation
│       │   │   └── SchemaValidator.java      # JSON schema validation (optional)
│       │   │
│       │   └── servlet/
│       │       └── ScenarioServlet.java      # REST API endpoints
│       │
│       ├── src/main/resources/
│       │   └── logback.xml                    # Logging configuration
│       │
│       ├── src/main/webapp/
│       │   ├── WEB-INF/
│       │   │   ├── web.xml                    # Deployment descriptor (ADD-ON MODE)
│       │   │   └── contextviews/
│       │   │       └── json/
│       │   │           ├── main.json         # Master configuration (ALWAYS THIS NAME)
│       │   │           └── forms/
│       │   │               ├── EXAMPLE_LIST.json   # Grid schema
│       │   │               └── EXAMPLE_FORM.json   # Form schema
│       │   │
│       │   └── index.html                     # Welcome page
│       │
│       └── src/test/java/                     # Test classes
│
└── STRUCTURE.md                               # Architecture documentation
```

---

## Usage Patterns

### Pattern 1: Generate Integration Package

```bash
# Step 1: Install archetype to local Maven repo
cd maven-archetype
mvn clean install

# Step 2: Generate integration package
cd /path/to/workspace
mvn archetype:generate \
  -DarchetypeGroupId=com.sportello \
  -DarchetypeArtifactId=sportello-contextview-archetype \
  -DarchetypeVersion=1.0.0-SNAPSHOT \
  -DgroupId=com.example \
  -DartifactId=contextview-integration \
  -Dversion=1.0.0-SNAPSHOT \
  -Dpackage=com.example.contextview \
  -DtargetWebapp=my-existing-webapp \
  -DtargetWebappPath=/opt/tomcat/webapps/my-existing-webapp

# Step 3: Review generated files
cd contextview-integration
tree
```

### Pattern 2: Copy Files to Existing Webapp

```bash
# Java classes
cp -r src/main/java/com/example/contextview/* \
  /path/to/existing-webapp/src/main/java/com/example/contextview/

# Web resources
cp -r src/main/webapp/WEB-INF/contextviews \
  /path/to/existing-webapp/src/main/webapp/WEB-INF/

# Merge web.xml configuration
# Manually add <context-param> entries to existing web.xml
```

### Pattern 3: Add New ContextView

**Step 1**: Edit `main.json`
```json
{
  "contextviews": {
    "LIST_ORDERS": {
      "title": "Orders",
      "route": "orders",
      "component": "custom-grid",
      "roles": ["admin", "user"],
      "options": {
        "schema": "ORDER_LIST",
        "api": [
          {"method": "GET", "url": "api/orders"}
        ]
      }
    }
  }
}
```

**Step 2**: Create schema file `forms/ORDER_LIST.json`
```json
{
  "schema": {
    "id": {"type": "number", "title": "Order ID"},
    "customer": {"type": "string", "title": "Customer"},
    "total": {"type": "number", "title": "Total", "format": "currency"}
  },
  "grid": [
    {"key": "id"},
    {"key": "customer"},
    {"key": "total"}
  ]
}
```

**Step 3**: No code changes needed - configuration is automatically processed!

### Pattern 4: Test API Endpoints

```bash
# Get full configuration
curl http://localhost:8080/my-webapp/api/contextview/config?role=admin

# List all contextviews
curl http://localhost:8080/my-webapp/api/contextview/list

# Get specific contextview
curl http://localhost:8080/my-webapp/api/contextview/LIST_ORDERS
```

---

## Known Issues and Solutions

### Issue 1: Multi-Module Confusion
**Problem**: Archetype initially assumed multi-module architecture.

**Solution**: Clarified that webapp = single module. Configuration always in `main.json`.

**Files Changed**:
- ScenarioServlet.java: Removed `{moduleName}` parameter
- archetype-metadata.xml: Removed `moduleName` property
- main.json: Renamed from `{artifactId}.json`

### Issue 2: Standalone vs Add-On
**Problem**: Initial design generated complete standalone webapp.

**Solution**: Changed to integration package model with `targetWebapp` parameter.

**Files Changed**:
- archetype-metadata.xml: Added `targetWebapp`, `targetWebappPath`
- web.xml: Added instructions for manual integration
- Documentation: Changed deployment model

### Issue 3: Variable Config Filename
**Problem**: Config filename was `{artifactId}.json` causing confusion.

**Solution**: Fixed to always `main.json` for predictability.

**Files Changed**:
- ScenarioServlet.java: Hardcoded `"json/main.json"`
- main.json: Renamed from `{artifactId}.json`

---

## Integration with Existing Webapps

### Prerequisites
- Java 11+ or Java 17+
- Jakarta EE 9+ (or Java EE 8 with javax packages)
- Servlet container (Tomcat 10+, TomEE 9+)
- Jackson library for JSON processing

### Step-by-Step Integration

**1. Generate Integration Package**
```bash
mvn archetype:generate \
  -DarchetypeGroupId=com.sportello \
  -DarchetypeArtifactId=sportello-contextview-archetype \
  -DgroupId=com.mycompany \
  -DartifactId=contextview-support \
  -Dpackage=com.mycompany.contextview \
  -DtargetWebapp=my-app
```

**2. Copy Java Classes**
```bash
# Copy generated classes to your webapp source
cp -r contextview-support/src/main/java/com/mycompany/contextview \
  my-app/src/main/java/com/mycompany/
```

**3. Copy Web Resources**
```bash
# Copy contextview configuration directory
cp -r contextview-support/src/main/webapp/WEB-INF/contextviews \
  my-app/src/main/webapp/WEB-INF/
```

**4. Update web.xml**
Add to your existing `web.xml`:
```xml
<context-param>
    <param-name>app.name</param-name>
    <param-value>main</param-value>
</context-param>

<context-param>
    <param-name>contextviews.path</param-name>
    <param-value>${catalina.base}/webapps/my-app/WEB-INF/contextviews</param-value>
</context-param>
```

**5. Add Dependencies to pom.xml**
```xml
<dependencies>
    <!-- Jackson for JSON processing -->
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.15.0</version>
    </dependency>

    <!-- SLF4J for logging -->
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-api</artifactId>
        <version>2.0.7</version>
    </dependency>

    <!-- Jakarta Servlet API -->
    <dependency>
        <groupId>jakarta.servlet</groupId>
        <artifactId>jakarta.servlet-api</artifactId>
        <version>5.0.0</version>
        <scope>provided</scope>
    </dependency>
</dependencies>
```

**6. Build and Deploy**
```bash
cd my-app
mvn clean package
cp target/my-app.war $CATALINA_HOME/webapps/
```

**7. Verify Installation**
```bash
# Check if servlet is loaded (should see in logs):
# "Initializing ScenarioProcessor for app 'main'"

# Test API endpoint:
curl http://localhost:8080/my-app/api/contextview/config
```

---

## Advanced Topics

### Custom Schema Types

Schema files support various field types:

```json
{
  "schema": {
    "text_field": {
      "type": "string",
      "title": "Text",
      "required": true,
      "maxLength": 255
    },
    "textarea_field": {
      "type": "string",
      "title": "Description",
      "widget": "textarea",
      "rows": 5
    },
    "number_field": {
      "type": "number",
      "title": "Quantity",
      "minimum": 0,
      "maximum": 100
    },
    "select_field": {
      "type": "string",
      "title": "Category",
      "enum": ["option1", "option2", "option3"],
      "default": "option1"
    },
    "date_field": {
      "type": "string",
      "title": "Date",
      "format": "date"
    },
    "boolean_field": {
      "type": "boolean",
      "title": "Active",
      "default": false
    }
  }
}
```

### Dynamic Enums

Schemas can reference API endpoints for dynamic dropdown options:

```json
{
  "schema": {
    "category_id": {
      "type": "number",
      "title": "Category",
      "enum_api": {
        "url": "api/categories",
        "value_field": "id",
        "label_field": "name"
      }
    }
  }
}
```

### Conditional Fields

Fields can be shown/hidden based on other field values:

```json
{
  "schema": {
    "type": {
      "type": "string",
      "enum": ["person", "company"]
    },
    "first_name": {
      "type": "string",
      "condition": {
        "field": "type",
        "equals": "person"
      }
    },
    "company_name": {
      "type": "string",
      "condition": {
        "field": "type",
        "equals": "company"
      }
    }
  }
}
```

### Complex Actions

Action configurations support various patterns:

```json
{
  "actions-row": {
    "items": [
      {
        "code": "edit",
        "title": "Edit",
        "icon": "it-pencil",
        "action": {"type": "goto-page"},
        "goto-contextview": "PRODUCT_FORM",
        "roles": ["admin"]
      },
      {
        "code": "delete",
        "title": "Delete",
        "icon": "it-delete",
        "action": {"type": "api-call"},
        "api": {
          "method": "DELETE",
          "url": "api/products/<id>",
          "confirm": "Are you sure?"
        },
        "roles": ["admin"]
      },
      {
        "code": "export",
        "title": "Export PDF",
        "icon": "it-file-pdf",
        "action": {"type": "download"},
        "url": "api/products/<id>/pdf"
      }
    ]
  }
}
```

---

## Future Extensions

### Planned Features
1. **Schema Validation**: Validate JSON schemas against JSON Schema spec
2. **Custom Processors**: Plugin system for custom contextview processing
3. **Multi-Language Support**: i18n integration
4. **Audit Logging**: Track configuration changes
5. **Migration Tools**: PHP to Java configuration converter

### Extension Points

**Custom Processor**:
```java
public interface ScenarioProcessorExtension {
    JsonNode process(JsonNode contextview, ProcessingContext context);
}
```

**Custom Filter**:
```java
public interface ScenarioFilter {
    boolean shouldInclude(JsonNode contextview, FilterContext context);
}
```

---

## Debugging Tips

### Enable Debug Logging

Add to `logback.xml`:
```xml
<logger name="contextview" level="DEBUG"/>
<logger name="contextview.processor.ScenarioProcessor" level="TRACE"/>
```

### Common Issues

**1. Schema not found**
```
ERROR: Schema file not found: json/forms/PRODUCT_LIST.json
```
**Solution**: Check file exists and path is correct relative to `contextviews/` directory.

**2. Role filtering removes all contextviews**
```
{"contextviews": {}}
```
**Solution**: Check role value passed to API. Ensure contextviews have correct `roles` array.

**3. Breadcrumb infinite loop**
```
ERROR: Breadcrumb generation exceeded maximum depth
```
**Solution**: Check for circular `goto-contextview` references.

**4. JSON parsing error**
```
JsonParseException: Unexpected character...
```
**Solution**: Validate JSON with `jq` or online validator. Common issues: trailing commas, unquoted keys.

### Testing Configuration

Use `jq` to validate and format:
```bash
# Validate JSON
jq empty main.json

# Pretty print
jq . main.json

# Extract contextview keys
jq '.contextviews | keys' main.json
```

---

## Glossary

- **ContextView**: Page/screen configuration defining UI and behavior
- **Schema**: JSON structure defining form/grid fields
- **Schema Inlining**: Process of loading external schema file and merging into contextview
- **Breadcrumb**: Navigation hierarchy showing parent-child relationships
- **Role Authorization**: Access control based on user roles
- **Component**: Frontend UI component type (custom-grid, custom-form, custom-view)
- **Action**: User interaction (button, link) with associated behavior
- **goto-contextview**: Navigation link creating parent-child relationship
- **DataTableHelper Pattern**: PHP/Java pattern for CRUD operations
- **Add-on Mode**: Integration package copied into existing webapp
- **Single Module Architecture**: One webapp = one configuration file

---

## Related Documentation

- `STRUCTURE.md` - Detailed project structure explanation
- `maven-archetype/README.md` - Archetype usage instructions
- `archetype-resources/src/main/webapp/WEB-INF/contextviews/json/main.json` - Example configuration
- PHP ContextView: `app/Components/ContextViewHelpers.php` - Original implementation

---

## Agent Checklist for New Sessions

When starting a new session on this project, verify understanding of:

- [ ] Single module architecture (not multi-module)
- [ ] Configuration always named `main.json`
- [ ] Add-on integration model (not standalone)
- [ ] Schema inlining pattern
- [ ] Role-based authorization wildcards
- [ ] Breadcrumb generation algorithm
- [ ] PHP to Java translation mapping
- [ ] API endpoint patterns
- [ ] Integration steps for existing webapps

---

**Document Version**: 1.0
**Last Updated**: 2025-10-09
**Target Audience**: AI Agents, Future Development Sessions
